# Notion Sync Skill

**Purpose**: Sync local files (Markdown, PDF, images) to Notion databases with GitHub CDN backup.

**Created**: 2026-02-09  
**Author**: È∏°Âì• (Keith's AI Assistant)  
**Compatibility**: OpenClaw agents, Python 3.9+

---

## Overview

This skill provides two synchronization methods:

| Method | Description | Use Case |
|--------|-------------|----------|
| **Simple Sync** | Upload file ‚Üí GitHub CDN ‚Üí Notion link | Single files (papers, reports) |
| **Report Sync** | Markdown ‚Üí Main page + Subpages | Multi-chapter documents |

---

## Quick Start

### 1. Configuration

Create a configuration file or set environment variables:

```bash
# Required Environment Variables
export NOTION_KEY="[REDACTED][REDACTED]026236eWN3zCq0z3WXMfnqvioA8wYyAXLOvhc3Hs"
export NOTION_DATABASE_ID="[REDACTED]b6a57f8348a9d0014c0fd0f7c4"
export GITHUB_TOKEN="[REDACTED]0086BjmP8EvgAma0veh1FLwWv3xLyd3COjOg"
export GITHUB_OWNER="keithhegit"
export GITHUB_REPO="piclist-cdn"
```

### 2. Simple File Sync

```bash
# Basic upload (GitHub only)
python3 sync_to_notion_cdn.py report.pdf

# Upload + Notion sync
python3 sync_to_notion_cdn.py report.md --notion

# Custom category
python3 sync_to_notion_cdn.py image.png --notion --category "Research"
```

### 3. Multi-Chapter Report Sync

```bash
cd /path/to/reports
python3 sync_to_notion_subpages.py
```

---

## Notion Database Schema

### Resources Database (‰∏ªÊï∞ÊçÆÂ∫ì)

| Field | Type | Description |
|-------|------|-------------|
| Recurso | title | File title |
| URL | url | CDN link |
| Á±ªÂûã | multi_select | File type (PDF, MD, Image) |
| Ê†áÁ≠æ | multi_select | Tags (Auto-Sync, CDN, etc.) |

### Example API Call

```python
import requests

headers = {
    "Authorization": "Bearer YOUR_NOTION_KEY",
    "Notion-Version": "2025-09-03",
    "Content-Type": "application/json"
}

data = {
    "parent": {"database_id": "YOUR_DB_ID"},
    "properties": {
        "Recurso": {"title": [{"text": {"content": "Êñá‰ª∂Âêç.md"}}]},
        "URL": {"url": "https://cdn.jsdelivr.net/..."},
        "Á±ªÂûã": {"multi_select": [{"name": "MD"}, {"name": "Research"}]},
        "Ê†áÁ≠æ": {"multi_select": [{"name": "Auto-Sync"}]}
    }
}

response = requests.post(
    "https://api.notion.com/v1/pages",
    headers=headers,
    json=data
)
```

---

## Architecture

```
Local File ‚Üí GitHub (CDN) ‚Üí Notion Database
                        ‚Üì
                  Main Page (CDN Link)
                        ‚Üì
              Subpages (Chapter divisions)
```

### Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Local File  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GitHub API  ‚îÇ  ‚Üê Upload + Base64 encode
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ jsDelivr CDN ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ  CDN Link   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  Notion API ‚îÇ  ‚Üê Create page with CDN link
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ Notion Page ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Detailed Implementation

### 1. GitHub Upload

```python
import base64, requests
from datetime import datetime

def upload_github(path, folder="images"):
    """Upload file to GitHub, return CDN URL"""
    name = os.path.basename(path)
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    github_path = f"{folder}/{timestamp}_{name}"
    
    url = f"https://api.github.com/repos/{OWNER}/{REPO}/contents/{github_path}"
    payload = {
        "message": f"Upload {name}",
        "content": base64.b64encode(open(path, "rb").read()).decode(),
        "branch": "master"
    }
    
    response = requests.put(
        url,
        headers={"Authorization": f"token {GITHUB_TOKEN}"},
        json=payload
    )
    
    if response.status_code == 201:
        cdn_url = f"https://cdn.jsdelivr.net/gh/{OWNER}/{REPO}/{github_path}"
        return {"success": True, "cdn": cdn_url}
    return {"success": False, "error": response.text}
```

### 2. Markdown to Notion Blocks

```python
import re

def markdown_to_blocks(markdown_text):
    """Convert Markdown to Notion block objects"""
    lines = markdown_text.strip().split('\n')
    blocks = []
    
    for line in lines:
        stripped = line.strip()
        if not stripped:
            continue
        
        # Heading (# ## ###)
        if stripped.startswith('#'):
            match = re.match(r'^(#{1,6})\s+(.+)$', stripped)
            if match:
                level = len(match.group(1))
                text = match.group(2)
                block_type = f"heading_{min(level, 3)}"
                blocks.append({
                    "object": "block",
                    "type": block_type,
                    block_type: {"rich_text": [{"type": "text", "text": {"content": text}}]}
                })
                continue
        
        # Bullet list (- )
        if stripped.startswith('- '):
            blocks.append({
                "object": "block",
                "type": "bulleted_list_item",
                "bulleted_list_item": {"rich_text": [{"type": "text", "text": {"content": stripped[2:]}}]}
            })
            continue
        
        # Numbered list (1. )
        match = re.match(r'^\d+\.\s+(.+)$', stripped)
        if match:
            blocks.append({
                "object": "block",
                "type": "numbered_list_item",
                "numbered_list_item": {"rich_text": [{"type": "text", "text": {"content": match.group(1)}}]}
            })
            continue
        
        # Paragraph
        blocks.append({
            "object": "block",
            "type": "paragraph",
            "paragraph": {"rich_text": [{"type": "text", "text": {"content": stripped}}]}
        })
    
    return blocks
```

### 3. Create Page with Subpages

```python
def create_page_with_subpages(title, filepath, database_id):
    """Create Notion page with subpages from Markdown"""
    # Read and parse Markdown
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Split into chapters (## headings)
    chapters = re.split(r'\n## ', content)
    
    # Create main page
    main_page_data = {
        "parent": {"database_id": database_id},
        "properties": {
            "Recurso": {"title": [{"text": {"content": f"ü¶û {title}"}}]},
            "URL": {"url": get_cdn_url(filepath)},
            "Á±ªÂûã": {"multi_select": [{"name": "Ë∞ÉÁ†îÊä•Âëä"}]},
            "Ê†áÁ≠æ": {"multi_select": [{"name": "Auto-Sync"}]}
        },
        "children": [
            {
                "object": "block",
                "type": "paragraph",
                "paragraph": {"rich_text": [{"type": "text", "text": {"content": f"üìë Êú¨Êä•ÂëäÂÖ±{len(chapters)}Á´†ËäÇ"}}]}
        ]
    }
    
    response = requests.post(
        "https://api.notion.com/v1/pages",
        headers=HEADERS,
        json=main_page_data
    )
    
    if response.status_code != 200:
        return False, response.json()
    
    main_page_id = response.json().get('id')
    
    # Create subpages (max 4, 85 blocks each)
    chapter_names = ["SCQA‰∏éÊ¶ÇËø∞", "ÂÖ¨Âè∏Ê¶ÇÂÜµ", "Ê†∏ÂøÉ‰∫ßÂìÅ", "Â∏ÇÂú∫ÂÆö‰Ωç"]
    max_subpages = 4
    
    for i in range(max_subpages):
        start = i * (len(chapters) // max_subpages)
        end = min((i + 1) * (len(chapters) // max_subpages, len(chapters))
        
        if start >= end:
            break
        
        chapter_content = "## " + "## ".join(chapters[start:end])
        blocks = markdown_to_blocks(chapter_content)[:85]
        
        subpage_data = {
            "parent": {"page_id": main_page_id},
            "properties": {"title": [{"text": {"content": f"Á¨¨{start+1}-{end}Á´†: {chapter_names[i]}"}}]},
            "children": blocks
        }
        
        requests.post(
            "https://api.notion.com/v1/pages",
            headers=HEADERS,
            json=subpage_data
        )
    
    return True, {"main_page_id": main_page_id}
```

---

## Checking Existing Pages

```python
def check_exists(query_title, database_id):
    """Check if page exists in database"""
    url = "https://api.notion.com/v1/search"
    data = {
        "query": query_title,
        "filter": {"property": "object", "value": "page"},
        "page_size": 20
    }
    
    response = requests.post(url, headers=HEADERS, json=data)
    
    if response.status_code == 200:
        results = response.json().get('results', [])
        for r in results:
            existing_title = r.get('properties', {}).get('Recurso', {}).get('title', [])
            if existing_title:
                if existing_title[0].get('plain_text', '').replace('.md', '').strip() == query_title.replace('.md', '').strip():
                    return True, r.get('id')
    
    return False, None
```

---

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `NOTION_KEY` | Yes | Notion Integration Token (format: `[REDACTED]...`) |
| `NOTION_DATABASE_ID` | Yes | Database ID (32-character hex string) |
| `GITHUB_TOKEN` | Yes | GitHub Personal Access Token |
| `GITHUB_OWNER` | Yes | GitHub username |
| `GITHUB_REPO` | Yes | Repository name for CDN |

---

## Error Handling

```python
# Common errors and solutions

# 1. Rate limiting
if response.status_code == 429:
    time.sleep(60)  # Wait 1 minute
    retry()

# 2. Invalid database ID
if "object" not in response.json():
    raise ValueError("Invalid database_id")

# 3. Block limit exceeded (100 blocks/page)
if len(blocks) > 100:
    blocks = blocks[:100]
    # Create additional pages for remaining content

# 4. Unauthorized
if response.status_code == 401:
    raise PermissionError("Check NOTION_KEY")
```

---

## Files Included

| File | Purpose |
|------|---------|
| `sync_to_notion_cdn.py` | Simple file sync + GitHub CDN |
| `sync_to_notion_subpages.py` | Multi-chapter Markdown sync |
| `sync_to_notion_cdn_simple.py` | Simplified version (single function) |

---

## Usage Examples

### Sync a Single Paper

```bash
python3 sync_to_notion_cdn.py paper.pdf --notion --category "Research"
```

### Sync a Research Report

```bash
cd /Users/tianyunkeji/clawd/Â∏ÇÂú∫Ë∞ÉÁ†î/Âç´ÊòüÈÄöËÆØÂú∞Èù¢ÊÆµÊúçÂä°ÂïÜ
python3 sync_to_notion_subpages.py
```

### Programmatic Usage

```python
from sync_to_notion_cdn import sync_notion

result = sync_notion("/path/to/file.md", category="Research")
if result["success"]:
    print(f"Notion: {result['notion']}")
    print(f"CDN: {result['cdn']}")
```

---

## Limitations

1. **Rate Limits**: Notion API allows ~3 requests/second
2. **Block Limit**: 100 blocks per page (use subpages for longer content)
3. **File Size**: GitHub limit 25MB per file
4. **Images**: Images must be uploaded separately, referenced via URL

---

## Migration Checklist

When moving to a new environment:

- [ ] Export `NOTION_KEY` and `NOTION_DATABASE_ID`
- [ ] Export GitHub credentials
- [ ] Copy Python scripts (`sync_to_notion_cdn.py`, `sync_to_notion_subpages.py`)
- [ ] Update `DATABASE_ID` in scripts if changed
- [ ] Test with a small file first

---

## Security Notes

‚ö†Ô∏è **Important**:
- Never commit credentials to git
- Use environment variables or `.env` file
- Rotate tokens periodically
- Restrict Notion integration to specific databases only

---

## References

- [Notion API Documentation](https://developers.notion.com/)
- [GitHub REST API](https://docs.github.com/en/rest)
- [jsDelivr CDN](https://www.jsdelivr.com/)
